def cronExpr = env.BRANCH_IS_PRIMARY ? 'H * * * *' : ''

def reportsFolder = 'plugin-health-scoring'
def etagsFile = 'etags.txt'
def reportFile = 'scores.json'

pipeline {
  agent any

  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timeout(time: 5, unit: 'MINUTES')
    disableConcurrentBuilds()
  }

  triggers {
    cron( cronExpr )
  }

  stages {
    stage('Fetch API') {
      environment {
        REPORTS_FOLDER = reportsFolder
        ETAGS_FILE = etagsFile
        REPORT_FILE = reportFile
        URL = 'https://plugin-health.jenkins.io/api/scores'
      }

      steps {
        sh '''
          curl -LSsO https://reports.jenkins.io/${REPORTS_FOLDER}/${ETAGS_FILE} || echo "No previous etags file."
          bash fetch-report.sh
          mkdir -p "${reportsFolder}"
          cp "${reportFile}" "${etagsFile}" "${reportsFolder}"
        '''
      }

      post {
        success {
          archiveArtifacts artifacts: "${reportFile}, ${etagsFile}"
        }
      }
    }

    stage('Publish') {
      when {
        infra.isTrusted()
      }

      steps {
        publishReports([ "${reportsFolder}/${reportFile}", "${reportsFolder}/${etagsFile}" ])
      }
    }
  }
}
